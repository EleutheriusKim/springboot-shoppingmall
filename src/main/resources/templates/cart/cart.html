<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/default-layout}">

    <div class="main-content" layout:fragment="content">
        <script>
            var header = $("meta[name='_csrf_header']").attr("content");
            var token  = $("meta[name='_csrf']").attr("content");
        </script>
        <script th:inline="javascript">

            var cartObj = {

                getCartList : function(obj) {
                    var userId = [[${session.user.getId()}]],
                        page = obj ? $(obj).data("page") : 1;

                    $.ajax({
                        type : "GET",
                        url  : "/user/" + userId + "/cart/" + page,
                        contentType : "application/json",
                        beforeSend	: function(xhr) {
                            xhr.setRequestHeader(header, token);
                        },
                        success : function(data) {
                            var checkoutPrice = 0;

                            if (data) {
                                var cartList = data.cartList.content,
                                    cartPagingDto = data.cartPagingDto,
                                    $cartTableBody = $(".cart-table-body"),
                                    $cartListPagination = $(".cart-list-pagination");

                                $cartTableBody.empty();
                                $cartListPagination.empty();

                                checkoutPrice = data.checkoutPrice;

                                if (cartList.length > 0) {

                                    cartList.forEach(function(element) {
                                        var amount = Number(element.productCount) * Number(element.product.price);

                                        var catTr = "<tr class='cart_itme'>" +
                                            "<td class=\"product-remove\"><a data-cart-id='" + element.id + "' title=\"Remove this item\" class=\"remove\" href=\"#\" onclick='cartObj.removeCart(this)'>×</a></td>" +
                                            "<td class=\"product-thumbnail\"><a href='/productDetails?productId=" + element.product.id +  "'><img alt=\"member\" src='" + element.product.titleImg + "'></a></td>" +
                                            "<td class=\"product-name\"><a class=\"text-theme-colored\" href='/productDetails?productId=" + element.product.id +  "'>" + element.product.productNm + "</a>" +
                                            "<ul class=\"variation\">" +
                                            "</ul></td>" +
                                            "<td class=\"product-price\"><span class=\"amount\">" + element.product.price + "</span></td>" +
                                            "<td class=\"product-quantity\"><span class=\"amount\">" + element.productCount + "</span></span></td>" +
                                            "<td class=\"product-subtotal\"><span class=\"amount\">" + amount + "</span></td>" +
                                            "</tr>"

                                        $cartTableBody.append(catTr);
                                    })

                                    // 페이징 그리기
                                    // Prev 페이지
                                    if (cartPagingDto.scaleStartPage !== 1) {
                                        var prevLi =
                                            "<li><a data-page='" + cartPagingDto.prevPage + "' class='product-list-page' href='#' onclick='cartObj.getCartList(this)' aria-label='Previous'><span aria-hidden='true'>&laquo;</span></a></li>";

                                        $cartListPagination.append(prevLi);
                                    }

                                    // 중간 페이지
                                    for (var i = cartPagingDto.scaleStartPage; i <= cartPagingDto.scaleEndPage; i++) {
                                        var pageLi = "";

                                        if (cartPagingDto.page === i) {
                                            pageLi = "<li class='active'><a data-page='" + i + "' class='product-list-page' href='#' onclick='cartObj.getCartList(this)'>" + i + "</a></li>";
                                        } else {
                                            pageLi = "<li class=''><a data-page='" + i + "' class='product-list-page' href='#' onclick='cartObj.getCartList(this)'>" + i + "</a></li>";
                                        }

                                        $cartListPagination.append(pageLi);
                                    }

                                    // Next 페이지
                                    if (cartPagingDto.scaleEndPage !== cartPagingDto.totPage) {
                                        var nextLi =
                                            "<li><a data-page='" + cartPagingDto.nextPage + "' class='product-list-page' href='#' onclick='cartObj.getCartList(this)' aria-label='Next'><span aria-hidden='true'>&raquo;</span></a></li>"

                                        $cartListPagination.append(nextLi);
                                    }
                                }
                            }

                            $("#checkout-price").text("결제금액 : " + checkoutPrice + "원")
                        },
                        error   : function(e) {

                        }
                    })
                },
                removeCart  : function(obj) {
                    var confirmChk = confirm("정말로 삭제하시겠습니까?");

                    if (confirmChk) {
                        var $obj = $(obj),
                            cartId = $obj.data("cartId");

                        $.ajax({
                            type : "DELETE",
                            url  : "/cart/" + cartId,
                            contentType : "application/json",
                            beforeSend  : function(xhr) {
                                xhr.setRequestHeader(header, token);
                            },
                            success : function(data) {
                                alert(data);

                                cartObj.getCartList();
                            },
                            error   : function(e) {
                                alert(e.responseText);
                            }
                        })
                    }
                }
            }

            $(function() {
                cartObj.getCartList();
            })
        </script>

        <section>
            <div class="container">
                <div class="section-content">
                    <div class="row">
                        <div class="col-md-10 col-md-offset-1">
                            <table class="table table-striped table-bordered tbl-shopping-cart">
                                <thead>
                                <tr>
                                    <th></th>
                                    <th>Photo</th>
                                    <th>Product Name</th>
                                    <th>Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                </tr>
                                </thead>
                                <tbody class="cart-table-body">

                                </tbody>

                            </table>
                            <div class="col-md-12">
                                <nav>
                                    <ul class="pagination cart-list-pagination theme-skin-green mt-0">

                                    </ul>
                                </nav>
                            </div>
                            <table class="table table-striped table-bordered tbl-shopping-cart">
                                <tbody>
                                    <tr class="cart_item">
                                        <td colspan="3"><div class="coupon">
                                            <label for="cart-coupon">Coupon: </label>
                                            <input id="cart-coupon" type="text" placeholder="Coupon code" value="" name="coupon_code">
                                            <button type="button" class="btn btn-success">쿠폰 적용</button>
                                        </div></td>
                                        <td id="checkout-price" colspan="2"></td>
                                        <td><button type="button" class="btn pull-right btn-success">결제하기</button></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <!-- end main-content -->
    </div>

</html>